<!DOCTYPE html>
<html>
<head>
    <title>The Grid</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/static/main.css">
</head>
<body>
    <div id="main"></div>
    <div id="prompt"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/static/vendor/jquery/dist/jquery.min.js"></script>
    <script src="/static/vendor/lodash/dist/lodash.min.js"></script>
    <script src="/static/vendor/URIjs/src/URI.min.js"></script>
    <script src="/static/grid.js"></script>
    <script src="/static/colors.js"></script>
    <script type="text/template" id="t-register">
        <form class="register">
            <input name="address" placeholder="Address #" type="text" pattern="\d*" autocomplete="off"required >
            <button type="submit">Enter</button>
        </form>
    </script>
    <script type="text/template" id="t-reset">
        <a class="reset" href="/"></a>
    </script>

    <script type="text/javascript">
    $(function () {

        var grid            = Grid.make(15, 6)
        ,   socket          = io()
        ,   delay           = 100
        ,   $body           = $('body')
        ,   $main           = $('#main')
        ,   $prompt         = $('#prompt')
        ,   resetPrompt     = _.template($('#t-reset').html())
        ,   registerPrompt  = _.template($('#t-register').html())

        function randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function randomColor() {
            return colors[randomInt(0, colors.length)]
        }

        function address() {
            return URI(window.location).search(true).address
        }

        function needsAddress() {
            return !address()
        }

        function showPrompt(prompt, fullscreen) {
            $prompt.toggleClass('fullscreen', !!fullscreen)
            $prompt.html(prompt())
        }

        function start() {
            if (needsAddress()) {
                showPrompt(registerPrompt, true)
            } else {
                showPrompt(resetPrompt)
            }
        }

        function distance(toAddress) {
            return grid.distance(
                grid.coords(address())[0],
                grid.coords(address())[1]
            )(toAddress)
        }



        $body.on('click #main', function (ev) {
            socket.emit('toggle', {
                color: randomColor(),
                address: address()
            })
        })

        socket.on('toggle', function(message){
            _.delay(function () {
                $main.css('background-color', message.color)
            }, distance(message.address) * delay)
        })

        start()
    })
    </script>
</body>
</html>
